!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).ClientMonitor={})}(this,function(e){"use strict";function t(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}class o{buildURL(e,t){return`${t}${{ERROR:"/error",ERRORS:"/errors",PERF:"/perf",SEGMENT:"/segment",SEGMENTS:"/segments"}[e]||""}`}sendError(e){const t=this.buildURL("ERROR",e.collector);this.sendByFetch(t,e)}sendPerformance(e){const t=this.buildURL("PERF",e.collector);this.sendByFetch(t,e)}sendSegments(e){var t;const o=this.buildURL("SEGMENTS",(null==(t=e[0])?void 0:t.service)||"");this.sendByFetch(o,e)}sendSegmentsByBeacon(e){var t;const o=this.buildURL("SEGMENTS",(null==(t=e[0])?void 0:t.service)||"");this.sendByBeacon(o,e)}sendByFetch(e,t){e&&fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(e=>{if(e.status>=400)throw new Error(`Request failed with status ${e.status}`)}).catch(e=>{console.warn("Report error:",e)})}sendByBeacon(e,t){e&&("function"==typeof navigator.sendBeacon?navigator.sendBeacon(e,new Blob([JSON.stringify(t)],{type:"application/json"})):this.sendByFetch(e,t))}}class s{constructor(e){this.enabled=!1,this.options=e,this.reportService=new o}enable(){this.enabled||(window.addEventListener("error",this.handleError.bind(this)),this.enabled=!0)}disable(){window.removeEventListener("error",this.handleError.bind(this)),this.enabled=!1}handleError(e){var o;const s={uniqueId:t(),service:this.options.service,serviceVersion:this.options.serviceVersion,pagePath:this.options.pagePath,category:"JS_ERROR",grade:"ERROR",errorUrl:e.filename||window.location.href,message:e.message,collector:this.options.collector,stack:null==(o=e.error)?void 0:o.stack};this.reportService.sendError(s)}capture(e,o){const s={uniqueId:t(),service:this.options.service,serviceVersion:this.options.serviceVersion,pagePath:this.options.pagePath,category:"JS_ERROR",grade:"ERROR",errorUrl:window.location.href,message:e.message,collector:this.options.collector,stack:e.stack,...o};this.reportService.sendError(s)}updateConfig(e){this.options={...this.options,...e}}}class r{constructor(e){this.enabled=!1,this.options=e,this.reportService=new o}enable(){this.enabled||(window.addEventListener("unhandledrejection",this.handleRejection.bind(this)),this.enabled=!0)}disable(){window.removeEventListener("unhandledrejection",this.handleRejection.bind(this)),this.enabled=!1}handleRejection(e){var o,s;const r={uniqueId:t(),service:this.options.service,serviceVersion:this.options.serviceVersion,pagePath:this.options.pagePath,category:"PROMISE_ERROR",grade:"ERROR",errorUrl:window.location.href,message:(null==(o=e.reason)?void 0:o.message)||"Unhandled Promise Rejection",collector:this.options.collector,stack:null==(s=e.reason)?void 0:s.stack};this.reportService.sendError(r)}updateConfig(e){this.options={...this.options,...e}}}class i{constructor(e){this.enabled=!1,this.originalXHROpen=null,this.originalXHRSend=null,this.options=e,this.reportService=new o}enable(){this.enabled||(this.interceptXHR(),this.enabled=!0)}disable(){this.enabled&&(this.restoreXHR(),this.enabled=!1)}interceptXHR(){const e=this;this.originalXHROpen=XMLHttpRequest.prototype.open,this.originalXHRSend=XMLHttpRequest.prototype.send,XMLHttpRequest.prototype.open=function(t,o,s,r,i){const n=this;return n._apmMethod=t,n._apmUrl=o.toString(),n._apmStartTime=Date.now(),e.originalXHROpen.call(this,t,o,s??!1,r,i)},XMLHttpRequest.prototype.send=function(o){const s=this;return s.addEventListener("error",function(){const o={uniqueId:t(),service:e.options.service,serviceVersion:e.options.serviceVersion,pagePath:e.options.pagePath,category:"AJAX_ERROR",grade:"ERROR",errorUrl:s._apmUrl||window.location.href,message:`AJAX request failed: ${s._apmMethod} ${s._apmUrl}`,collector:e.options.collector,stack:void 0};e.reportService.sendError(o)}),s.addEventListener("timeout",function(){const o={uniqueId:t(),service:e.options.service,serviceVersion:e.options.serviceVersion,pagePath:e.options.pagePath,category:"AJAX_ERROR",grade:"ERROR",errorUrl:s._apmUrl||window.location.href,message:`AJAX request timeout: ${s._apmMethod} ${s._apmUrl}`,collector:e.options.collector,stack:void 0};e.reportService.sendError(o)}),e.originalXHRSend.call(this,o)}}restoreXHR(){this.originalXHROpen&&(XMLHttpRequest.prototype.open=this.originalXHROpen),this.originalXHRSend&&(XMLHttpRequest.prototype.send=this.originalXHRSend)}updateConfig(e){this.options={...this.options,...e}}}class n{constructor(e){this.enabled=!1,this.options=e,this.reportService=new o}enable(){this.enabled||(window.addEventListener("error",this.handleError.bind(this),!0),this.enabled=!0)}disable(){window.removeEventListener("error",this.handleError.bind(this),!0),this.enabled=!1}handleError(e){const o=e.target;if(o instanceof HTMLScriptElement){const e={uniqueId:t(),service:this.options.service,serviceVersion:this.options.serviceVersion,pagePath:this.options.pagePath,category:"RESOURCE_ERROR",grade:"ERROR",errorUrl:o.src||window.location.href,message:`Resource load error: ${o.tagName}`,collector:this.options.collector};this.reportService.sendError(e)}else if(o instanceof HTMLLinkElement){const e={uniqueId:t(),service:this.options.service,serviceVersion:this.options.serviceVersion,pagePath:this.options.pagePath,category:"RESOURCE_ERROR",grade:"ERROR",errorUrl:o.href||window.location.href,message:`Resource load error: ${o.tagName}`,collector:this.options.collector};this.reportService.sendError(e)}else if(o instanceof HTMLImageElement){const e={uniqueId:t(),service:this.options.service,serviceVersion:this.options.serviceVersion,pagePath:this.options.pagePath,category:"RESOURCE_ERROR",grade:"ERROR",errorUrl:o.src||window.location.href,message:`Resource load error: ${o.tagName}`,collector:this.options.collector};this.reportService.sendError(e)}}updateConfig(e){this.options={...this.options,...e}}}class a{constructor(e){this.enabled=!1,this.options=e,this.reportService=new o}enable(e){this.enabled||(e&&e.config&&(e.config.errorHandler=(e,o,s)=>{const r={uniqueId:t(),service:this.options.service,serviceVersion:this.options.serviceVersion,pagePath:this.options.pagePath,category:"VUE_ERROR",grade:"ERROR",errorUrl:window.location.href,message:s,collector:this.options.collector,stack:e.stack};this.reportService.sendError(r)}),this.enabled=!0)}updateConfig(e){this.options={...this.options,...e}}}class c{constructor(e){this.options=e,this.jsErrors=new s(e),this.promiseErrors=new r(e),this.ajaxErrors=new i(e),this.resourceErrors=new n(e),this.vueErrors=new a(e)}enable(e){this.options={...this.options,...e},e.jsErrors&&(this.jsErrors.enable(),this.promiseErrors.enable(),e.vue&&this.vueErrors.enable(e.vue)),e.apiErrors&&this.ajaxErrors.enable(),e.resourceErrors&&this.resourceErrors.enable()}capture(e,t){this.jsErrors.capture(e,t)}updateConfig(e){this.options={...this.options,...e},this.jsErrors.updateConfig(e),this.promiseErrors.updateConfig(e),this.ajaxErrors.updateConfig(e),this.resourceErrors.updateConfig(e),this.vueErrors.updateConfig(e)}}class h{constructor(e){this.options=e,this.reportService=new o}track(){"complete"===document.readyState?this.collectAndReport():window.addEventListener("load",()=>this.collectAndReport(),{once:!0})}collectAndReport(){if(!this.options.autoTracePerf)return;const e={uniqueId:t(),service:this.options.service,serviceVersion:this.options.serviceVersion,pagePath:this.options.pagePath,collector:this.options.collector,timing:performance.timing};this.options.useFmp&&(e.fmpTime=this.calculateFMP()),this.reportService.sendPerformance(e)}calculateFMP(){return 0}updateConfig(e){this.options={...this.options,...e}}}class p{constructor(){}enable(){}disable(){}updateConfig(e){}}class l{constructor(){}enable(){}disable(){}updateConfig(e){}}class d{constructor(e){this.segments=[],this.timer=null,this.options=e,this.reportService=new o,this.xhrInterceptor=new p,this.fetchInterceptor=new l}enable(e){this.options={...this.options,...e},this.xhrInterceptor.enable(),this.fetchInterceptor.enable(),this.setupReportTimer(),this.setupUnloadHandler()}disable(){this.xhrInterceptor.disable(),this.fetchInterceptor.disable(),this.clearReportTimer()}setupReportTimer(){null!=this.timer&&clearInterval(this.timer),this.timer=window.setInterval(()=>{this.segments.length>0&&(this.reportService.sendSegments([...this.segments]),this.segments.splice(0,this.segments.length))},this.options.traceTimeInterval??6e4)}clearReportTimer(){null!=this.timer&&(clearInterval(this.timer),this.timer=null)}setupUnloadHandler(){window.addEventListener("beforeunload",()=>{this.segments.length>0&&this.reportService.sendSegmentsByBeacon([...this.segments])})}setCustomTags(e){this.options.customTags=e,this.xhrInterceptor.updateConfig(this.options),this.fetchInterceptor.updateConfig(this.options)}updateConfig(e){this.options={...this.options,...e},this.xhrInterceptor.updateConfig(this.options),this.fetchInterceptor.updateConfig(this.options)}}class u{constructor(e){this.options={collector:"undefined"!=typeof window?window.location.origin:"",service:"",serviceVersion:"",pagePath:"undefined"!=typeof window?window.location.pathname:"",...e},this.errorTracker=new c(this.options),this.performanceTracker=new h(this.options),this.traceTracker=new d(this.options)}init(e){this.options={...this.options,...e},this.validateOptions(),(e.jsErrors||e.apiErrors||e.resourceErrors)&&this.errorTracker.enable(e),e.autoTracePerf&&!e.enableSPA&&this.performanceTracker.track(),this.traceTracker.enable(e)}updateConfig(e){this.options={...this.options,...e},this.errorTracker.updateConfig(this.options),this.performanceTracker.updateConfig(this.options),this.traceTracker.updateConfig(this.options)}captureError(e,t){this.errorTracker.capture(e,t)}trackPerformance(e){e&&this.updateConfig(e),this.performanceTracker.track()}setCustomTags(e){this.validateTags(e)&&this.traceTracker.setCustomTags(e)}validateOptions(){const{collector:e,service:t,pagePath:o,serviceVersion:s}=this.options;"string"!=typeof e&&(this.options.collector="undefined"!=typeof window?window.location.origin:""),"string"!=typeof t&&(this.options.service=""),"string"!=typeof o&&(this.options.pagePath="undefined"!=typeof window?window.location.pathname:""),"string"!=typeof s&&(this.options.serviceVersion="")}validateTags(e){if(!e)return!1;if(!Array.isArray(e))return console.warn("customTags must be an array"),!1;const t=e.every(e=>e&&"string"==typeof e.key&&"string"==typeof e.value);return t||console.warn("customTags format error"),t}getOptions(){return this.options}}const g=function(){const e=new u;return{customOptions:{},register(t){this.customOptions={...this.customOptions,...t},e.init(t)},setPerformance(t){this.customOptions={...this.customOptions,...t,useFmp:!1},e.updateConfig(this.customOptions),e.trackPerformance(this.customOptions)},catchErrors(t){const{service:o,pagePath:s,serviceVersion:r,collector:i}=t,n={...t,service:o||this.customOptions.service,pagePath:s||this.customOptions.pagePath,serviceVersion:r||this.customOptions.serviceVersion,collector:i||this.customOptions.collector};e.init(n)},reportFrameErrors(t,o){e.captureError(o,{service:t.service,pagePath:t.pagePath,serviceVersion:t.serviceVersion,collector:t.collector})},setCustomTags(t){this.validateTags(t)&&(this.customOptions.customTags=t,e.setCustomTags(t))},validateTags(e){if(!e)return!1;if(!Array.isArray(e))return this.customOptions.customTags=void 0,console.warn("customTags error"),!1;let t=!0;for(const o of e)o&&o.key&&o.value||(t=!1);return t||(this.customOptions.customTags=void 0,console.warn("customTags error")),t},validateOptions(){const{collector:e,service:t,pagePath:o,serviceVersion:s,jsErrors:r,apiErrors:i,resourceErrors:n,autoTracePerf:a,useFmp:c,enableSPA:h,traceSDKInternal:p,detailMode:l,noTraceOrigins:d,traceTimeInterval:u,vue:g}=this.customOptions;this.validateTags(this.customOptions.customTags),"string"!=typeof e&&(this.customOptions.collector="undefined"!=typeof window?window.location.origin:""),"string"!=typeof t&&(this.customOptions.service=""),"string"!=typeof o&&(this.customOptions.pagePath="undefined"!=typeof window?window.location.pathname:""),"string"!=typeof s&&(this.customOptions.serviceVersion=""),"boolean"!=typeof r&&(this.customOptions.jsErrors=!0),"boolean"!=typeof i&&(this.customOptions.apiErrors=!0),"boolean"!=typeof n&&(this.customOptions.resourceErrors=!0),"boolean"!=typeof a&&(this.customOptions.autoTracePerf=!0),"boolean"!=typeof c&&(this.customOptions.useFmp=!1),"boolean"!=typeof h&&(this.customOptions.enableSPA=!1),"boolean"!=typeof p&&(this.customOptions.traceSDKInternal=!1),"boolean"!=typeof l&&(this.customOptions.detailMode=!0),Array.isArray(d)||(this.customOptions.noTraceOrigins=[]),"number"!=typeof u&&(this.customOptions.traceTimeInterval=6e4),"function"!=typeof g&&(this.customOptions.vue=void 0)},performance(t){e.trackPerformance(t)}}}();"undefined"!=typeof window&&(window.ClientMonitor=g),e.APMClient=u,e.default=g,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
//# sourceMappingURL=index.js.map
